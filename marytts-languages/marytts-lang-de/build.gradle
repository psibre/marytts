sourceSets {
    lexicon {
        resources {
            srcDir 'lib/modules/de/lexicon'
        }
    }
}

processLexiconResources {
    filesMatching('de.txt') {
        // drop lines that are comments or lack a transcription
        def regex = new org.apache.tools.ant.types.RegularExpression()
        regex.pattern = /^\s*[^#\s]+\s+[^\s]+/
        filter(org.apache.tools.ant.filters.LineContainsRegExp, regexps: [regex])
        // insert pipe delimiter
        filter { it.split(' ', 3).join('|') }
    }
}

createLexicon {
    def workingDir = sourceSets.lexicon.output.resourcesDir
    inputs.files file("$workingDir/allophones.de.xml"), file("$workingDir/de.txt")
    outputs.files file("$workingDir/de_lexicon.fst"), file("$workingDir/de.lts")
}

processResources {
    from createLexicon, {
        rename { "marytts/language/de/lexicon/$it" }
    }
}

test {
    useTestNG() {
        suiteXmlBuilder().suite(name: 'lexicon') {
            parameter(name: 'allophoneset', value: file('lib/modules/de/lexicon/allophones.de.xml'))
            parameter(name: 'lexicon', value: file('lib/modules/de/lexicon/de.txt'))
            parameter(name: 'lts', value: '/marytts/language/de/lexicon/de.lts')
            parameter(name: 'fst', value: '/marytts/language/de/lexicon/de_lexicon.fst')
            test(name: 'lexicon') {
                classes([:]) {
                    'class'(name: 'marytts.language.de.GermanLTSTest')
                }
            }
        }
    }
}
